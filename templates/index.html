<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>365å­˜éŒ¢è¨ˆç•«</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #2ecc71; --bg: #f0f2f5; --danger: #e74c3c; --gray: #94a3b8; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .top-nav { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .user-pill { cursor:pointer; background:#fff; padding:6px 14px; border-radius:20px; border:1px solid #ddd; font-size:12px; font-weight: bold; }
        .main-header { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 15px 0 5px; }
        .invite-box { text-align: center; margin-bottom: 20px; background: #fff; padding: 8px; border-radius: 12px; border: 1px dashed var(--primary); cursor: pointer; }
        .card { background: #fff; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .p-bar { background: #eee; height: 12px; border-radius: 6px; overflow: hidden; margin: 12px 0; }
        .fill { height: 100%; background: var(--primary); transition: width 0.6s ease; }
        .money-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .day-box { background: #fff; border-radius: 12px; padding: 12px 0; text-align: center; cursor: pointer; border: 1px solid #eee; position: relative; }
        .day-box.done { background: #e8f5e9; border-color: var(--primary); color: var(--primary); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 100; padding: 15px; }
        .modal-body { background: #fff; padding: 20px; border-radius: 20px; width: 100%; max-width: 380px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin-top: 5px; }
        .btn-go { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .danger-zone { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #eee; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <header class="top-nav">
            <div class="user-pill" onclick="openProfile()">ğŸ‘¤ {{ user.username }} (x{{ user.multiplier }})</div>
            <a href="/logout" style="color:var(--danger); text-decoration:none; font-size:13px; font-weight:bold;">ç™»å‡º</a>
        </header>

        <div class="main-header">
            <h1 style="margin:0; font-size: 24px;">{{ group.name }}</h1>
            <i class="fa-solid fa-pen-to-square" style="color: var(--primary); cursor: pointer; font-size: 20px;" onclick="editGroupName()"></i>
        </div>
        
        <div class="invite-box" onclick="copyCode('{{ group.group_uuid }}')">
            é‚€è«‹ç¢¼ï¼š<strong style="color:var(--primary);">{{ group.group_uuid }}</strong> 
            <span style="font-size:10px; color:#bbb;">(é»æ“Šè¤‡è£½)</span>
        </div>

        <section class="card">
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; text-align:center; font-size:12px;">
                <div>å·²å­˜<br><strong>${{ "{:,}".format(current) }}</strong></div>
                <div>ç›®æ¨™<br><strong>${{ "{:,}".format(target) }}</strong></div>
                <div>é€²åº¦<br><strong>{{ my_pct }}%</strong></div>
            </div>
            <div class="p-bar">
                <div class="fill" style="width: {{ my_pct }}%;"></div>
            </div>
        </section>

        <div class="money-grid">
            {% for d in range(1, 366) %}
            {% set r = saved_days.get(d) %}
            <div class="day-box {{ 'done' if r else '' }}" onclick="handleBox(this)" data-day="{{ d }}" data-done="{{ '1' if r else '0' }}" data-rid="{{ r.id if r else '' }}" data-note="{{ r.note if r else '' }}" data-date="{{ r.date if r else '' }}" data-photo="{{ r.photo if r else '' }}">
                <div style="font-size:9px; opacity:0.5;">Day {{ d }}</div>
                <div style="font-size:14px; font-weight:bold;">${{ d * user.multiplier }}</div>
                {% if r %}<i class="fa-solid fa-check" style="position:absolute; top:4px; right:4px; font-size:8px;"></i>{% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="p-box" class="modal"><div class="modal-body">
        <h3 style="text-align:center; margin-top:0;">å¸³è™Ÿè¨­å®š</h3>
        <form action="/update_profile" method="post" onsubmit="return confirm('è®Šæ›´å€ç‡å°‡æ¸…ç©ºç´€éŒ„ï¼Œç¢ºå®šå—ï¼Ÿ')">
            <label style="font-size:12px; color:#888;">å­˜éŒ¢å€ç‡</label>
            <select name="multiplier">
                {% for i in [1, 2, 3, 5, 10] %}<option value="{{ i }}" {{ 'selected' if user.multiplier == i }}>{{ i }} å€</option>{% endfor %}
            </select>
            <button type="submit" class="btn-go" style="background:#3498db;">å„²å­˜è¨­å®š</button>
        </form>
        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
        <form action="/update_password" method="post">
            <input type="password" name="old_password" placeholder="èˆŠå¯†ç¢¼" required>
            <input type="password" name="new_password" placeholder="æ–°å¯†ç¢¼" required>
            <button type="submit" class="btn-go" style="background:var(--gray);">ä¿®æ”¹å¯†ç¢¼</button>
        </form>
        <div class="danger-zone">
            <button type="button" onclick="resetPlan()" style="color:var(--danger); cursor:pointer; background:none; border:none; text-decoration:underline; font-size:12px;">æ¸…ç©ºç›®å‰ç´€éŒ„</button>
            <form action="/delete_account" method="post" onsubmit="return confirm('âš ï¸ ç¢ºå®šè¨»éŠ·å¸³è™Ÿï¼Ÿ')" style="margin-top:10px;">
                <button type="submit" class="btn-go" style="background:var(--danger); font-size:12px;">æ°¸ä¹…è¨»éŠ·å¸³è™Ÿ</button>
            </form>
        </div>
        <button type="button" onclick="closeAll()" style="width:100%; border:none; background:none; color:#999; margin-top:15px;">é—œé–‰</button>
    </div></div>

    <div id="m-box" class="modal"><div class="modal-body">
        <h3 id="m-t" style="text-align:center;"></h3>
        <form id="m-f" method="post" enctype="multipart/form-data">
            <input type="hidden" name="day_number" id="m-d"><input type="hidden" name="record_id" id="m-ri">
            <input type="date" name="save_date" id="m-date">
            <input type="text" name="note" id="m-n" placeholder="å¯«é»ä»€éº¼...">
            <input type="file" name="photo_file" accept="image/*" style="margin-top:10px;">
            <button type="submit" class="btn-go">å„²å„²</button>
        </form>
        <button type="button" onclick="closeAll()" style="width:100%; border:none; background:none; color:#999; margin-top:10px;">å–æ¶ˆ</button>
    </div></div>

    <form id="quickNameForm" action="/quick_update_name" method="post" style="display:none;"><input type="hidden" name="new_group_name" id="newGroupNameInput"></form>

    <script>
        function openProfile() { document.getElementById('p-box').style.display='flex'; }
        function closeAll() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
        function copyCode(t) { navigator.clipboard.writeText(t).then(() => alert('é‚€è«‹ç¢¼å·²è¤‡è£½ï¼')); }
        function resetPlan() { if(confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ç´€éŒ„ï¼Ÿ')) window.location.href='/reset_all_records'; }
        function editGroupName() {
            const res = prompt("è«‹è¼¸å…¥æ–°è¨ˆç•«åç¨±ï¼š");
            if(res) { document.getElementById('newGroupNameInput').value=res; document.getElementById('quickNameForm').submit(); }
        }
        function handleBox(el) {
            const d = el.dataset; document.getElementById('m-box').style.display='flex';
            document.getElementById('m-d').value=d.day; document.getElementById('m-n').value=d.note;
            if(d.done==='1') {
                document.getElementById('m-t').innerText='ç·¨è¼¯ Day '+d.day; document.getElementById('m-f').action='/update';
                document.getElementById('m-ri').value=d.rid; document.getElementById('m-date').value=d.date;
            } else {
                document.getElementById('m-t').innerText='å­˜å…¥ Day '+d.day; document.getElementById('m-f').action='/save';
                document.getElementById('m-date').value="{{ today }}";
            }
        }
    </script>
</body>
</html>